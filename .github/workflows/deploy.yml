name: Deploy to Production (AWS EC2)

# Ëß∏ÁôºÊ¢ù‰ª∂ÔºöÁï∂ push Âà∞ main ÂàÜÊîØÊôÇ
on:
  push:
    branches:
      - main
  # ÂÖÅË®±ÊâãÂãïËß∏Áôº
  workflow_dispatch:

# Áí∞Â¢ÉËÆäÊï∏
env:
  GO_VERSION: "1.24"
  NODE_VERSION: "20"
  PNPM_VERSION: "9"

jobs:
  # Job 1: ÈÄöÁü• - ÈÉ®ÁΩ≤ÈñãÂßã
  notify-start:
    name: Notify Deployment Start
    runs-on: ubuntu-latest

    steps:
      - name: üì¢ Send Discord Notification - Started
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
          -H "Content-Type: application/json" \
          -d '{
            "content": "**(deploying) asset-manager deploy**",
            "embeds": [{
              "title": "Deploy details",
              "color": 3447003,
              "fields": [
                {
                  "name": "Branch",
                  "value": "`${{ github.ref_name }}`",
                  "inline": true
                },
                {
                  "name": "User",
                  "value": "`${{ github.actor }}`",
                  "inline": true
                },
                {
                  "name": "Commit",
                  "value": "[`'"${GITHUB_SHA:0:7}"'`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})"
                },
                {
                  "name": "Time",
                  "value": "'"$(date -u +'%Y-%m-%d %H:%M:%S UTC')"'"
                }
              ],
              "footer": {
                "text": "GitHub Actions"
              },
              "timestamp": "'"$(date -u +'%Y-%m-%dT%H:%M:%SZ')"'"
            }]
          }'

  # Job 2: Ê∏¨Ë©¶
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: notify-start

    # PostgreSQL service container for integration tests
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: asset_manager_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêπ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: backend/go.sum

      - name: üì¶ Install gotestsum
        run: go install gotest.tools/gotestsum@latest

      - name: üóÑÔ∏è Run database migrations
        working-directory: backend
        env:
          TEST_DB_HOST: localhost
          TEST_DB_PORT: 5432
          TEST_DB_USER: postgres
          TEST_DB_PASSWORD: postgres
          TEST_DB_NAME: asset_manager_test
        run: |
          # Install golang-migrate
          curl -L https://github.com/golang-migrate/migrate/releases/download/v4.17.0/migrate.linux-amd64.tar.gz | tar xvz
          sudo mv migrate /usr/local/bin/migrate

          # Run migrations
          migrate -path migrations -database "postgresql://${TEST_DB_USER}:${TEST_DB_PASSWORD}@${TEST_DB_HOST}:${TEST_DB_PORT}/${TEST_DB_NAME}?sslmode=disable" up

      - name: üß™ Run backend tests
        working-directory: backend
        env:
          TEST_DB_HOST: localhost
          TEST_DB_PORT: 5432
          TEST_DB_USER: postgres
          TEST_DB_PASSWORD: postgres
          TEST_DB_NAME: asset_manager_test
        run: |
          gotestsum --format testname -- -cover ./...

      - name: ‚úÖ Tests passed
        run: echo "All tests passed successfully!"

  # Job 3: Âª∫ÁΩÆ Docker Images
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üèóÔ∏è Build Backend Docker image
        working-directory: backend
        run: |
          docker build -t asset-manager-backend:${{ github.sha }} .
          docker tag asset-manager-backend:${{ github.sha }} asset-manager-backend:latest

      - name: üèóÔ∏è Build Frontend Docker image
        working-directory: frontend
        run: |
          docker build -t asset-manager-frontend:${{ github.sha }} .
          docker tag asset-manager-frontend:${{ github.sha }} asset-manager-frontend:latest

      - name: üíæ Save Docker images
        run: |
          docker save asset-manager-backend:latest | gzip > backend-image.tar.gz
          docker save asset-manager-frontend:latest | gzip > frontend-image.tar.gz

      - name: üì§ Upload Backend image artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-image
          path: backend-image.tar.gz
          retention-days: 1

      - name: üì§ Upload Frontend image artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-image
          path: frontend-image.tar.gz
          retention-days: 1

  # Job 4: ÈÉ®ÁΩ≤Âà∞ EC2
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì• Download Backend image artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-image

      - name: üì• Download Frontend image artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-image

      - name: üîë Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: üì§ Upload Docker images to EC2
        run: |
          scp -i ~/.ssh/id_rsa backend-image.tar.gz ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:/tmp/
          scp -i ~/.ssh/id_rsa frontend-image.tar.gz ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:/tmp/

      - name: üì§ Upload deployment files to EC2
        run: |
          scp -i ~/.ssh/id_rsa docker-compose.yml ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:/home/ubuntu/asset-manager/
          scp -i ~/.ssh/id_rsa nginx.conf ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:/home/ubuntu/asset-manager/

      - name: üöÄ Deploy on EC2
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e

            echo "üíæ Ê™¢Êü•Á£ÅÁ¢üÁ©∫Èñì..."
            df -h / | grep -v Filesystem

            echo "üßπ Ê∏ÖÁêÜËàä Docker Ë≥áÊ∫êÔºàÈÉ®ÁΩ≤ÂâçÔºâ..."
            docker image prune -a -f || true
            docker container prune -f || true
            docker volume prune -f || true

            echo "üì¶ ËºâÂÖ• Backend Docker image..."
            docker load < /tmp/backend-image.tar.gz

            echo "üì¶ ËºâÂÖ• Frontend Docker image..."
            docker load < /tmp/frontend-image.tar.gz

            echo "üîÑ ÂàáÊèõÂà∞ÊáâÁî®Á®ãÂºèÁõÆÈåÑ..."
            cd /home/ubuntu/asset-manager

            echo "üîÑ ÈáçÁΩÆÊú¨Âú∞‰øÆÊîπ..."
            git fetch origin
            git reset --hard origin/main

            echo "‚¨áÔ∏è  ÊãâÂèñÊúÄÊñ∞Á®ãÂºèÁ¢º..."
            git pull origin main

            echo "üîê Ê™¢Êü•Áí∞Â¢ÉËÆäÊï∏Ê™îÊ°à..."
            if [ -f .env.production ]; then
              echo "‚úÖ Áí∞Â¢ÉËÆäÊï∏Ê™îÊ°àÂ≠òÂú®"
            else
              echo "‚ùå ÈåØË™§ÔºöÊâæ‰∏çÂà∞ .env.production Ê™îÊ°à"
              echo "Ë´ãÂèÉËÄÉÊñá‰ª∂Ë®≠ÂÆöÁí∞Â¢ÉËÆäÊï∏"
              exit 1
            fi

            echo "üóÑÔ∏è ÂÇô‰ªΩË≥áÊñôÂ∫´..."
            if docker ps | grep -q "asset-manager-postgres"; then
              bash ./scripts/backup-db.sh || echo "‚ö†Ô∏è  ÂÇô‰ªΩÂ§±ÊïóÔºå‰ΩÜÁπºÁ∫åÈÉ®ÁΩ≤"
            else
              echo "‚ö†Ô∏è  Ë≥áÊñôÂ∫´ÂÆπÂô®Êú™ÈÅãË°åÔºåË∑≥ÈÅéÂÇô‰ªΩ"
            fi

            echo "üõë ÂÅúÊ≠¢ËàäÂÆπÂô®..."
            docker-compose down || true

            echo "üöÄ ÂïüÂãïÊñ∞ÂÆπÂô®..."
            docker-compose --env-file .env.production up -d

            echo "‚è≥ Á≠âÂæÖÂÆπÂô®ÂïüÂãï..."
            sleep 15

            echo "üßπ Ê∏ÖÁêÜËàä Docker imagesÔºàÈÉ®ÁΩ≤ÂæåÔºâ..."
            docker image prune -a -f || true

            echo "üóëÔ∏è  Ê∏ÖÁêÜÊö´Â≠òÊ™îÊ°à..."
            rm -f /tmp/backend-image.tar.gz
            rm -f /tmp/frontend-image.tar.gz

            echo "üíæ Ê™¢Êü•Á£ÅÁ¢üÁ©∫ÈñìÔºàÈÉ®ÁΩ≤ÂæåÔºâ..."
            df -h / | grep -v Filesystem

            echo "‚úÖ ÈÉ®ÁΩ≤ÂÆåÊàêÔºÅ"
          EOF

      - name: üè• Health Check
        run: |
          echo "Á≠âÂæÖÊáâÁî®Á®ãÂºèÂïüÂãï..."
          sleep 30

          echo "Âü∑Ë°åÂÅ•Â∫∑Ê™¢Êü•..."

          # Ê™¢Êü• Backend API
          backend_response=$(ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "curl -s -o /dev/null -w '%{http_code}' http://localhost:8080/health" || echo "000")
          if [ "$backend_response" = "200" ]; then
            echo "‚úÖ Backend API ÂÅ•Â∫∑Ê™¢Êü•ÈÄöÈÅé"
          else
            echo "‚ùå Backend API ÂÅ•Â∫∑Ê™¢Êü•Â§±ÊïóÔºÅHTTP ÁãÄÊÖãÁ¢º: $backend_response"
            ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "docker-compose logs --tail=50 backend"
            exit 1
          fi

          # Ê™¢Êü• Frontend (Êé•Âèó 200 Êàñ 307 ÈáçÂÆöÂêë)
          frontend_response=$(ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "curl -s -o /dev/null -w '%{http_code}' http://localhost:3000" || echo "000")
          if [ "$frontend_response" = "200" ] || [ "$frontend_response" = "307" ]; then
            echo "‚úÖ Frontend ÂÅ•Â∫∑Ê™¢Êü•ÈÄöÈÅé (HTTP $frontend_response)"
          else
            echo "‚ùå Frontend ÂÅ•Â∫∑Ê™¢Êü•Â§±ÊïóÔºÅHTTP ÁãÄÊÖãÁ¢º: $frontend_response"
            ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "docker-compose logs --tail=50 frontend"
            exit 1
          fi

          # Ê™¢Êü• Nginx
          nginx_response=$(ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "curl -s -o /dev/null -w '%{http_code}' http://localhost/health" || echo "000")
          if [ "$nginx_response" = "200" ]; then
            echo "‚úÖ Nginx ÂÅ•Â∫∑Ê™¢Êü•ÈÄöÈÅé"
          else
            echo "‚ùå Nginx ÂÅ•Â∫∑Ê™¢Êü•Â§±ÊïóÔºÅHTTP ÁãÄÊÖãÁ¢º: $nginx_response"
            ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "docker-compose logs --tail=50 nginx"
            exit 1
          fi

          echo "‚úÖ ÊâÄÊúâÊúçÂãôÂÅ•Â∫∑Ê™¢Êü•ÈÄöÈÅéÔºÅ"

      - name: üìä Deployment Summary
        if: always()
        run: |
          echo "## üöÄ ÈÉ®ÁΩ≤ÊëòË¶Å" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ÂàÜÊîØ**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: [\`${GITHUB_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Ëß∏ÁôºËÄÖ**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ÊôÇÈñì**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **ÁãÄÊÖã**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: \`asset-manager-backend:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`asset-manager-frontend:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

  # Job 5: ÈÄöÁü• - ÊàêÂäüÊàñÂ§±Êïó
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [notify-start, test, build, deploy]
    if: always()

    steps:
      - name: üì¢ Send Discord Notification - Success
        if: needs.deploy.result == 'success'
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
          -H "Content-Type: application/json" \
          -d '{
            "content": "**(success) asset-manager deploy**",
            "embeds": [{
              "title": "Deploy details",
              "color": 3066993,
              "fields": [
                {
                  "name": "Branch",
                  "value": "`${{ github.ref_name }}`",
                  "inline": true
                },
                {
                  "name": "User",
                  "value": "`${{ github.actor }}`",
                  "inline": true
                },
                {
                  "name": "Commit",
                  "value": "[`'"${GITHUB_SHA:0:7}"'`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})"
                },
                {
                  "name": "Environment",
                  "value": "Production"
                },
                {
                  "name": "URL",
                  "value": "http://${{ secrets.EC2_HOST }}"
                },
                {
                  "name": "Time",
                  "value": "'"$(date -u +'%Y-%m-%d %H:%M:%S UTC')"'"
                }
              ],
              "footer": {
                "text": "GitHub Actions"
              },
              "timestamp": "'"$(date -u +'%Y-%m-%dT%H:%M:%SZ')"'"
            }]
          }'

      - name: üì¢ Send Discord Notification - Failure
        if: needs.test.result == 'failure' || needs.build.result == 'failure' || needs.deploy.result == 'failure'
        run: |
          FAILED_STAGE="Deploy"
          if [ "${{ needs.test.result }}" = "failure" ]; then
            FAILED_STAGE="Test"
          elif [ "${{ needs.build.result }}" = "failure" ]; then
            FAILED_STAGE="Build"
          fi

          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
          -H "Content-Type: application/json" \
          -d '{
            "content": "**(failed) asset-manager deploy** @here",
            "embeds": [{
              "title": "Deploy details",
              "color": 15158332,
              "fields": [
                {
                  "name": "Branch",
                  "value": "`${{ github.ref_name }}`",
                  "inline": true
                },
                {
                  "name": "User",
                  "value": "`${{ github.actor }}`",
                  "inline": true
                },
                {
                  "name": "Commit",
                  "value": "[`'"${GITHUB_SHA:0:7}"'`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})"
                },
                {
                  "name": "Failed Stage",
                  "value": "'"$FAILED_STAGE"'"
                },
                {
                  "name": "View Logs",
                  "value": "[GitHub Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
                },
                {
                  "name": "Time",
                  "value": "'"$(date -u +'%Y-%m-%d %H:%M:%S UTC')"'"
                }
              ],
              "footer": {
                "text": "GitHub Actions"
              },
              "timestamp": "'"$(date -u +'%Y-%m-%dT%H:%M:%SZ')"'"
            }]
          }'
