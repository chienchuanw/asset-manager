name: Deploy to Production (AWS EC2)

# è§¸ç™¼æ¢ä»¶ï¼šç•¶ push åˆ° main åˆ†æ”¯æ™‚
on:
  push:
    branches:
      - main
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

# ç’°å¢ƒè®Šæ•¸
env:
  GO_VERSION: "1.24"
  NODE_VERSION: "20"
  PNPM_VERSION: "9"

jobs:
  # Job 1: æ¸¬è©¦
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    # PostgreSQL service container for integration tests
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: asset_manager_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: backend/go.sum

      - name: ðŸ“¦ Install gotestsum
        run: go install gotest.tools/gotestsum@latest

      - name: ðŸ—„ï¸ Run database migrations
        working-directory: backend
        env:
          TEST_DB_HOST: localhost
          TEST_DB_PORT: 5432
          TEST_DB_USER: postgres
          TEST_DB_PASSWORD: postgres
          TEST_DB_NAME: asset_manager_test
        run: |
          # Install golang-migrate
          curl -L https://github.com/golang-migrate/migrate/releases/download/v4.17.0/migrate.linux-amd64.tar.gz | tar xvz
          sudo mv migrate /usr/local/bin/migrate

          # Run migrations
          migrate -path migrations -database "postgresql://${TEST_DB_USER}:${TEST_DB_PASSWORD}@${TEST_DB_HOST}:${TEST_DB_PORT}/${TEST_DB_NAME}?sslmode=disable" up

      - name: ðŸ§ª Run backend tests
        working-directory: backend
        env:
          TEST_DB_HOST: localhost
          TEST_DB_PORT: 5432
          TEST_DB_USER: postgres
          TEST_DB_PASSWORD: postgres
          TEST_DB_NAME: asset_manager_test
        run: |
          gotestsum --format testname -- -cover ./...

      - name: âœ… Tests passed
        run: echo "All tests passed successfully!"

  # Job 2: å»ºç½® Docker Images
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ Build Backend Docker image
        working-directory: backend
        run: |
          docker build -t asset-manager-backend:${{ github.sha }} .
          docker tag asset-manager-backend:${{ github.sha }} asset-manager-backend:latest

      - name: ðŸ—ï¸ Build Frontend Docker image
        working-directory: frontend
        run: |
          docker build -t asset-manager-frontend:${{ github.sha }} .
          docker tag asset-manager-frontend:${{ github.sha }} asset-manager-frontend:latest

      - name: ðŸ’¾ Save Docker images
        run: |
          docker save asset-manager-backend:latest | gzip > backend-image.tar.gz
          docker save asset-manager-frontend:latest | gzip > frontend-image.tar.gz

      - name: ðŸ“¤ Upload Backend image artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-image
          path: backend-image.tar.gz
          retention-days: 1

      - name: ðŸ“¤ Upload Frontend image artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-image
          path: frontend-image.tar.gz
          retention-days: 1

  # Job 3: éƒ¨ç½²åˆ° EC2
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Backend image artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-image

      - name: ðŸ“¥ Download Frontend image artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-image

      - name: ðŸ”‘ Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸ“¤ Upload Docker images to EC2
        run: |
          scp -i ~/.ssh/id_rsa backend-image.tar.gz ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:/tmp/
          scp -i ~/.ssh/id_rsa frontend-image.tar.gz ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:/tmp/

      - name: ðŸ“¤ Upload deployment files to EC2
        run: |
          scp -i ~/.ssh/id_rsa docker-compose.yml ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:/home/ubuntu/asset-manager/
          scp -i ~/.ssh/id_rsa nginx.conf ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:/home/ubuntu/asset-manager/

      - name: ðŸš€ Deploy on EC2
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e

            echo "ðŸ’¾ æª¢æŸ¥ç£ç¢Ÿç©ºé–“..."
            df -h / | grep -v Filesystem

            echo "ðŸ§¹ æ¸…ç†èˆŠ Docker è³‡æºï¼ˆéƒ¨ç½²å‰ï¼‰..."
            docker image prune -a -f || true
            docker container prune -f || true
            docker volume prune -f || true

            echo "ðŸ“¦ è¼‰å…¥ Backend Docker image..."
            docker load < /tmp/backend-image.tar.gz

            echo "ðŸ“¦ è¼‰å…¥ Frontend Docker image..."
            docker load < /tmp/frontend-image.tar.gz

            echo "ðŸ”„ åˆ‡æ›åˆ°æ‡‰ç”¨ç¨‹å¼ç›®éŒ„..."
            cd /home/ubuntu/asset-manager

            echo "ðŸ”„ é‡ç½®æœ¬åœ°ä¿®æ”¹..."
            git fetch origin
            git reset --hard origin/main

            echo "â¬‡ï¸  æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼..."
            git pull origin main

            echo "ðŸ” æª¢æŸ¥ç’°å¢ƒè®Šæ•¸æª”æ¡ˆ..."
            if [ -f .env.production ]; then
              echo "âœ… ç’°å¢ƒè®Šæ•¸æª”æ¡ˆå­˜åœ¨"
            else
              echo "âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° .env.production æª”æ¡ˆ"
              echo "è«‹åƒè€ƒæ–‡ä»¶è¨­å®šç’°å¢ƒè®Šæ•¸"
              exit 1
            fi

            echo "ðŸ—„ï¸ å‚™ä»½è³‡æ–™åº«..."
            if docker ps | grep -q "asset-manager-postgres"; then
              bash ./scripts/backup-db.sh || echo "âš ï¸  å‚™ä»½å¤±æ•—ï¼Œä½†ç¹¼çºŒéƒ¨ç½²"
            else
              echo "âš ï¸  è³‡æ–™åº«å®¹å™¨æœªé‹è¡Œï¼Œè·³éŽå‚™ä»½"
            fi

            echo "ðŸ›‘ åœæ­¢èˆŠå®¹å™¨..."
            docker-compose down || true

            echo "ðŸš€ å•Ÿå‹•æ–°å®¹å™¨..."
            docker-compose --env-file .env.production up -d

            echo "â³ ç­‰å¾…å®¹å™¨å•Ÿå‹•..."
            sleep 15

            echo "ðŸ§¹ æ¸…ç†èˆŠ Docker imagesï¼ˆéƒ¨ç½²å¾Œï¼‰..."
            docker image prune -a -f || true

            echo "ðŸ—‘ï¸  æ¸…ç†æš«å­˜æª”æ¡ˆ..."
            rm -f /tmp/backend-image.tar.gz
            rm -f /tmp/frontend-image.tar.gz

            echo "ðŸ’¾ æª¢æŸ¥ç£ç¢Ÿç©ºé–“ï¼ˆéƒ¨ç½²å¾Œï¼‰..."
            df -h / | grep -v Filesystem

            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          EOF

      - name: ðŸ¥ Health Check
        run: |
          echo "ç­‰å¾…æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•..."
          sleep 15

          echo "åŸ·è¡Œå¥åº·æª¢æŸ¥..."

          # æª¢æŸ¥ Backend API
          backend_response=$(ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "curl -s -o /dev/null -w '%{http_code}' http://localhost:8080/health" || echo "000")
          if [ "$backend_response" = "200" ]; then
            echo "âœ… Backend API å¥åº·æª¢æŸ¥é€šéŽ"
          else
            echo "âŒ Backend API å¥åº·æª¢æŸ¥å¤±æ•—ï¼HTTP ç‹€æ…‹ç¢¼: $backend_response"
            ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "docker-compose logs --tail=50 backend"
            exit 1
          fi

          # æª¢æŸ¥ Frontend
          frontend_response=$(ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "curl -s -o /dev/null -w '%{http_code}' http://localhost:3000" || echo "000")
          if [ "$frontend_response" = "200" ]; then
            echo "âœ… Frontend å¥åº·æª¢æŸ¥é€šéŽ"
          else
            echo "âŒ Frontend å¥åº·æª¢æŸ¥å¤±æ•—ï¼HTTP ç‹€æ…‹ç¢¼: $frontend_response"
            ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "docker-compose logs --tail=50 frontend"
            exit 1
          fi

          # æª¢æŸ¥ Nginx
          nginx_response=$(ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "curl -s -o /dev/null -w '%{http_code}' http://localhost/health" || echo "000")
          if [ "$nginx_response" = "200" ]; then
            echo "âœ… Nginx å¥åº·æª¢æŸ¥é€šéŽ"
          else
            echo "âŒ Nginx å¥åº·æª¢æŸ¥å¤±æ•—ï¼HTTP ç‹€æ…‹ç¢¼: $nginx_response"
            ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "docker-compose logs --tail=50 nginx"
            exit 1
          fi

          echo "âœ… æ‰€æœ‰æœå‹™å¥åº·æª¢æŸ¥é€šéŽï¼"

      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ éƒ¨ç½²æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: [\`${GITHUB_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¸ç™¼è€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ™‚é–“**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‹€æ…‹**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: \`asset-manager-backend:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`asset-manager-frontend:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

  # Job 4: é€šçŸ¥
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [test, build, deploy]
    if: always()

    steps:
      - name: ðŸ“¢ Send Discord Notification - Started
        if: needs.test.result == 'success' && needs.build.result == 'success'
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
          -H "Content-Type: application/json" \
          -d '{
            "content": "**(deploying) asset-manager deploy**",
            "embeds": [{
              "title": "Deploy details",
              "color": 3447003,
              "fields": [
                {
                  "name": "Branch",
                  "value": "`${{ github.ref_name }}`",
                  "inline": true
                },
                {
                  "name": "User",
                  "value": "`${{ github.actor }}`",
                  "inline": true
                },
                {
                  "name": "Commit",
                  "value": "[`'"${GITHUB_SHA:0:7}"'`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})"
                },
                {
                  "name": "Time",
                  "value": "'"$(date -u +'%Y-%m-%d %H:%M:%S UTC')"'"
                }
              ],
              "footer": {
                "text": "GitHub Actions"
              },
              "timestamp": "'"$(date -u +'%Y-%m-%dT%H:%M:%SZ')"'"
            }]
          }'

      - name: ðŸ“¢ Send Discord Notification - Success
        if: needs.deploy.result == 'success'
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
          -H "Content-Type: application/json" \
          -d '{
            "content": "**(success) asset-manager deploy**",
            "embeds": [{
              "title": "Deploy details",
              "color": 3066993,
              "fields": [
                {
                  "name": "Branch",
                  "value": "`${{ github.ref_name }}`",
                  "inline": true
                },
                {
                  "name": "User",
                  "value": "`${{ github.actor }}`",
                  "inline": true
                },
                {
                  "name": "Commit",
                  "value": "[`'"${GITHUB_SHA:0:7}"'`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})"
                },
                {
                  "name": "Environment",
                  "value": "Production"
                },
                {
                  "name": "URL",
                  "value": "http://${{ secrets.EC2_HOST }}"
                },
                {
                  "name": "Time",
                  "value": "'"$(date -u +'%Y-%m-%d %H:%M:%S UTC')"'"
                }
              ],
              "footer": {
                "text": "GitHub Actions"
              },
              "timestamp": "'"$(date -u +'%Y-%m-%dT%H:%M:%SZ')"'"
            }]
          }'

      - name: ðŸ“¢ Send Discord Notification - Failure
        if: needs.test.result == 'failure' || needs.build.result == 'failure' || needs.deploy.result == 'failure'
        run: |
          FAILED_STAGE="Deploy"
          if [ "${{ needs.test.result }}" = "failure" ]; then
            FAILED_STAGE="Test"
          elif [ "${{ needs.build.result }}" = "failure" ]; then
            FAILED_STAGE="Build"
          fi

          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
          -H "Content-Type: application/json" \
          -d '{
            "content": "**(failed) asset-manager deploy** @here",
            "embeds": [{
              "title": "Deploy details",
              "color": 15158332,
              "fields": [
                {
                  "name": "Branch",
                  "value": "`${{ github.ref_name }}`",
                  "inline": true
                },
                {
                  "name": "User",
                  "value": "`${{ github.actor }}`",
                  "inline": true
                },
                {
                  "name": "Commit",
                  "value": "[`'"${GITHUB_SHA:0:7}"'`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})"
                },
                {
                  "name": "Failed Stage",
                  "value": "'"$FAILED_STAGE"'"
                },
                {
                  "name": "View Logs",
                  "value": "[é»žæ­¤æŸ¥çœ‹è©³ç´°éŒ¯èª¤](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
                },
                {
                  "name": "Time",
                  "value": "'"$(date -u +'%Y-%m-%d %H:%M:%S UTC')"'"
                }
              ],
              "footer": {
                "text": "GitHub Actions"
              },
              "timestamp": "'"$(date -u +'%Y-%m-%dT%H:%M:%SZ')"'"
            }]
          }'
