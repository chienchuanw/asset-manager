name: Deploy to EC2

on:
  # ç•¶ push åˆ° main åˆ†æ”¯æ™‚è‡ªå‹•éƒ¨ç½²
  push:
    branches:
      - main

  # å…è¨±æ‰‹å‹•è§¸ç™¼éƒ¨ç½²
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout ç¨‹å¼ç¢¼
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: è¨­å®š SSH
      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # Step 3: éƒ¨ç½²å‰é€šçŸ¥ Discord
      - name: Discord notification - Deploy started
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            curl -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "ğŸš€ éƒ¨ç½²é–‹å§‹",
                  "description": "Asset Manager æ­£åœ¨éƒ¨ç½²åˆ°æ­£å¼ç’°å¢ƒ",
                  "color": 3447003,
                  "fields": [
                    {
                      "name": "åˆ†æ”¯",
                      "value": "'"$GITHUB_REF_NAME"'",
                      "inline": true
                    },
                    {
                      "name": "æäº¤è€…",
                      "value": "'"$GITHUB_ACTOR"'",
                      "inline": true
                    },
                    {
                      "name": "æäº¤è¨Šæ¯",
                      "value": "'"$(git log -1 --pretty=%B | head -n 1)"'",
                      "inline": false
                    }
                  ],
                  "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
                }]
              }' \
              $DISCORD_WEBHOOK
          fi

      # Step 4: å‚™ä»½è³‡æ–™åº«
      - name: Backup database
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd /home/ubuntu/asset-manager
            
            # å¦‚æœå®¹å™¨æ­£åœ¨é‹è¡Œ,åŸ·è¡Œå‚™ä»½
            if docker ps | grep -q "asset-manager-postgres"; then
              echo "æ­£åœ¨å‚™ä»½è³‡æ–™åº«..."
              bash ./scripts/backup-db.sh || echo "å‚™ä»½å¤±æ•—,ä½†ç¹¼çºŒéƒ¨ç½²"
            else
              echo "è³‡æ–™åº«å®¹å™¨æœªé‹è¡Œ,è·³éå‚™ä»½"
            fi
          EOF

      # Step 5: æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼
      - name: Pull latest code
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd /home/ubuntu/asset-manager
            git fetch origin
            git reset --hard origin/main
            git clean -fd
          EOF

      # Step 6: å»ºç«‹ç’°å¢ƒè®Šæ•¸æª”æ¡ˆ
      - name: Create .env.production file
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd /home/ubuntu/asset-manager
            
            cat > .env.production << 'ENVEOF'
          # Database
          DB_HOST=postgres
          DB_PORT=5432
          DB_USER=${{ secrets.PROD_DB_USER }}
          DB_PASSWORD=${{ secrets.PROD_DB_PASSWORD }}
          DB_NAME=${{ secrets.PROD_DB_NAME }}

          # Redis
          REDIS_ADDR=redis:6379
          REDIS_PASSWORD=${{ secrets.PROD_REDIS_PASSWORD }}
          REDIS_DB=0
          PRICE_CACHE_EXPIRATION=5m

          # Application
          APP_PORT=8080
          GIN_MODE=release

          # API Keys
          FINMIND_API_KEY=${{ secrets.PROD_FINMIND_API_KEY }}
          COINGECKO_API_KEY=${{ secrets.PROD_COINGECKO_API_KEY }}
          ALPHA_VANTAGE_API_KEY=${{ secrets.PROD_ALPHA_VANTAGE_API_KEY }}

          # Scheduler
          SNAPSHOT_SCHEDULER_ENABLED=true
          SNAPSHOT_SCHEDULER_TIME=23:59

          # Auth
          AUTH_USERNAME=${{ secrets.PROD_AUTH_USERNAME }}
          AUTH_PASSWORD=${{ secrets.PROD_AUTH_PASSWORD }}
          JWT_SECRET=${{ secrets.PROD_JWT_SECRET }}

          # CORS
          CORS_ALLOWED_ORIGINS=http://${{ secrets.EC2_HOST }}

          # Frontend
          NEXT_PUBLIC_API_URL=http://${{ secrets.EC2_HOST }}/api
          ENVEOF
          EOF

      # Step 7: éƒ¨ç½²æ‡‰ç”¨ç¨‹å¼
      - name: Deploy application
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd /home/ubuntu/asset-manager
            
            # åœæ­¢ç¾æœ‰å®¹å™¨
            docker-compose down || true
            
            # å»ºç½®æ–°æ˜ åƒæª”
            docker-compose --env-file .env.production build --no-cache
            
            # å•Ÿå‹•å®¹å™¨
            docker-compose --env-file .env.production up -d
            
            # ç­‰å¾…æœå‹™å•Ÿå‹•
            echo "ç­‰å¾…æœå‹™å•Ÿå‹•..."
            sleep 30
          EOF

      # Step 8: å¥åº·æª¢æŸ¥
      - name: Health check
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
            # æª¢æŸ¥ Backend API
            if curl -f http://localhost:8080/health > /dev/null 2>&1; then
              echo "âœ“ Backend API å¥åº·æª¢æŸ¥é€šé"
            else
              echo "âœ— Backend API å¥åº·æª¢æŸ¥å¤±æ•—"
              docker-compose logs --tail=50 backend
              exit 1
            fi
            
            # æª¢æŸ¥ Frontend
            if curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "âœ“ Frontend å¥åº·æª¢æŸ¥é€šé"
            else
              echo "âœ— Frontend å¥åº·æª¢æŸ¥å¤±æ•—"
              docker-compose logs --tail=50 frontend
              exit 1
            fi
            
            # æª¢æŸ¥ Nginx
            if curl -f http://localhost/health > /dev/null 2>&1; then
              echo "âœ“ Nginx å¥åº·æª¢æŸ¥é€šé"
            else
              echo "âœ— Nginx å¥åº·æª¢æŸ¥å¤±æ•—"
              docker-compose logs --tail=50 nginx
              exit 1
            fi
          EOF

      # Step 9: æ¸…ç†èˆŠæ˜ åƒæª”
      - name: Cleanup old images
        if: success()
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
            docker image prune -f
          EOF

      # Step 10: éƒ¨ç½²æˆåŠŸé€šçŸ¥
      - name: Discord notification - Deploy success
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            curl -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "âœ… éƒ¨ç½²æˆåŠŸ",
                  "description": "Asset Manager å·²æˆåŠŸéƒ¨ç½²åˆ°æ­£å¼ç’°å¢ƒ",
                  "color": 3066993,
                  "fields": [
                    {
                      "name": "ç’°å¢ƒ",
                      "value": "Production",
                      "inline": true
                    },
                    {
                      "name": "ç¶²å€",
                      "value": "http://'"${{ secrets.EC2_HOST }}"'",
                      "inline": true
                    }
                  ],
                  "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
                }]
              }' \
              $DISCORD_WEBHOOK
          fi

      # Step 11: éƒ¨ç½²å¤±æ•—é€šçŸ¥
      - name: Discord notification - Deploy failed
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            curl -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "âŒ éƒ¨ç½²å¤±æ•—",
                  "description": "Asset Manager éƒ¨ç½²éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤",
                  "color": 15158332,
                  "fields": [
                    {
                      "name": "åˆ†æ”¯",
                      "value": "'"$GITHUB_REF_NAME"'",
                      "inline": true
                    },
                    {
                      "name": "æäº¤è€…",
                      "value": "'"$GITHUB_ACTOR"'",
                      "inline": true
                    },
                    {
                      "name": "æŸ¥çœ‹è©³æƒ…",
                      "value": "[GitHub Actions]('"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"')",
                      "inline": false
                    }
                  ],
                  "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
                }]
              }' \
              $DISCORD_WEBHOOK
          fi
